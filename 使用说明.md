# 域名CDN延迟测试工具 - 使用说明

## 🚀 功能概述

这是一个功能强大的域名CDN延迟测试工具，支持测试任意域名的CDN状态、网络延迟和服务器性能。

## ✨ 主要功能

### 1. Web界面测试
- **访问地址**: `http://localhost:3000`
- **功能特性**:
  - 支持自定义域名输入
  - 实时测试和自动测试模式
  - 6个详细的分析面板
  - 完整的测试历史记录

### 2. 命令行测试
- **脚本文件**: `cdn-test-cli.js`
- **功能特性**:
  - 支持批量测试
  - 详细的性能统计
  - 自动性能评级
  - 多种输出格式

### 3. API接口
- **端点**: `/api/test-domain`
- **功能特性**:
  - RESTful API设计
  - JSON格式响应
  - 支持GET和POST请求
  - 详细的错误处理

## 📊 测试指标

### 基础指标
- **总响应时间**: 从发起请求到收到响应的总时间
- **DNS解析时间**: 域名解析到IP地址的时间
- **TCP连接时间**: 建立TCP连接的时间
- **SSL握手时间**: SSL/TLS握手时间（HTTPS）
- **首字节时间(TTFB)**: Time to First Byte
- **内容下载时间**: 下载响应内容的时间

### CDN检测
- **CDN状态**: 检测是否通过CDN访问
- **CDN提供商**: 识别具体的CDN服务商
- **代理头信息**: 检测代理服务器相关头信息
- **CDN头信息**: 显示CDN特有的头信息

### 服务器信息
- **服务器软件**: 检测服务器类型和版本
- **响应大小**: 响应内容的大小
- **HTTP状态码**: 服务器响应状态
- **响应头信息**: 完整的HTTP响应头

### SSL证书信息
- **颁发机构**: SSL证书颁发机构
- **生效时间**: 证书开始生效时间
- **过期时间**: 证书过期时间
- **域名范围**: 证书覆盖的域名范围

## 🎯 使用方法

### Web界面使用

1. **基本测试**:
   - 打开浏览器访问 `http://localhost:3000`
   - 在输入框中输入要测试的域名（如：example.com）
   - 点击"开始测试"按钮

2. **自动测试**:
   - 输入域名后点击"自动测试"按钮
   - 系统会每5秒自动测试一次
   - 再次点击可停止自动测试

3. **查看结果**:
   - **概览面板**: 查看关键指标概览
   - **性能面板**: 详细的性能分析
   - **CDN分析面板**: CDN状态和头信息
   - **服务器面板**: 服务器信息和响应头
   - **SSL证书面板**: SSL证书详细信息
   - **历史记录面板**: 测试历史记录

### 命令行使用

1. **基本测试**:
   ```bash
   node cdn-test-cli.js
   ```

2. **自定义域名**:
   ```bash
   node cdn-test-cli.js --domain example.com
   # 或
   node cdn-test-cli.js -d example.com
   ```

3. **批量测试**:
   ```bash
   node cdn-test-cli.js --domain example.com --count 10
   # 或
   node cdn-test-cli.js -d example.com -c 10
   ```

4. **自定义间隔**:
   ```bash
   node cdn-test-cli.js --domain example.com --count 5 --interval 2000
   # 或
   node cdn-test-cli.js -d example.com -c 5 -i 2000
   ```

5. **自定义API地址**:
   ```bash
   node cdn-test-cli.js --domain example.com --api-url http://your-server:3000/api/test-domain
   # 或
   node cdn-test-cli.js -d example.com -a http://your-server:3000/api/test-domain
   ```

### API接口使用

1. **GET请求**:
   ```bash
   curl "http://localhost:3000/api/test-domain?domain=example.com"
   ```

2. **POST请求**:
   ```bash
   curl -X POST "http://localhost:3000/api/test-domain" \
     -H "Content-Type: application/json" \
     -d '{"domain": "example.com"}'
   ```

## 📈 结果解读

### 性能评级

- 🟢 **优秀**: 平均响应时间小于200ms
- 🟡 **良好**: 平均响应时间在200-500ms之间
- 🟠 **一般**: 平均响应时间在500-1000ms之间
- 🔴 **较慢**: 平均响应时间超过1000ms

### DNS解析评级

- 🟢 **优秀**: DNS解析时间小于50ms
- 🟡 **良好**: DNS解析时间在50-100ms之间
- 🔴 **较慢**: DNS解析时间超过100ms

### CDN状态说明

- **通过CDN**: 请求经过CDN加速，通常会显示CDN提供商信息
- **直连**: 请求直接到达源站，未经过CDN
- **检测到代理头**: 可能存在代理服务器、负载均衡器等

## 🔧 支持的CDN提供商

工具可以自动识别以下CDN提供商：

- **Cloudflare**: 通过 `cf-ray` 头信息识别
- **Azure CDN**: 通过 `x-azure-ref` 头信息识别
- **Amazon CloudFront**: 通过 `x-amz-cf-id` 头信息识别
- **Google Cloud CDN**: 通过 `x-edge-location` 头信息识别
- **阿里云CDN**: 通过 `ali-cdn-real-ip`、`x-cdn-request-id` 头信息识别
- **腾讯云CDN**: 通过 `x-cdn-log-id`、`x-cdn-src-ip` 头信息识别
- **Fastly**: 通过 `via` 头信息识别
- **Akamai**: 通过 `x-cache` 头信息识别

## 🛠️ 高级功能

### 1. 批量测试
可以编写脚本批量测试多个域名：

```bash
#!/bin/bash
domains=("example.com" "google.com" "cloudflare.com" "github.com")

for domain in "${domains[@]}"; do
    echo "Testing $domain..."
    node cdn-test-cli.js -d $domain -c 3
    echo "----------------------------------------"
done
```

### 2. 性能监控
设置定时任务进行持续监控：

```bash
# 每5分钟测试一次
*/5 * * * * /path/to/cdn-test-cli.js -d your-domain.com -c 1 >> /var/log/cdn-monitor.log
```

### 3. 结果导出
将测试结果导出为CSV格式：

```javascript
// 在命令行工具中添加CSV输出功能
// 或者使用API接口获取JSON数据后转换
```

## 🐛 故障排除

### 常见问题

1. **DNS解析失败**:
   - 检查域名是否正确
   - 检查网络连接
   - 检查DNS服务器设置

2. **连接超时**:
   - 检查目标服务器是否可访问
   - 检查防火墙设置
   - 增加超时时间

3. **SSL证书错误**:
   - 检查证书是否有效
   - 检查系统时间是否正确
   - 检查证书链是否完整

4. **API请求失败**:
   - 检查API服务是否运行
   - 检查网络连接
   - 检查请求参数格式

### 调试模式

使用 `-v` 参数启用详细输出：

```bash
# 在curl命令中添加详细输出
curl -v "http://localhost:3000/api/test-domain?domain=example.com"
```

## 📝 示例输出

### Web界面示例
```
域名: example.com
总响应时间: 174.00ms
DNS解析时间: 14.00ms
HTTP状态: 200 ✅
CDN状态: 直连
服务器软件: openresty
响应大小: 13.59 KB
```

### 命令行示例
```
=== 测试 1: cloudflare.com ===
HTTP状态: 301 🔄
总响应时间: 122.00ms
DNS解析时间: 7.00ms
CDN状态: 通过CDN
CDN提供商: Cloudflare
服务器软件: cloudflare
解析IP地址: 104.16.132.229

CDN头信息:
  cf-ray: 96af814cfeaf04c5-HKG

--- 性能评级 ---
🟢 优秀: 平均响应时间小于200ms
🟢 DNS解析优秀: 小于50ms
```

## 🔄 更新日志

### v2.0.0 (当前版本)
- ✅ 支持自定义域名测试
- ✅ 增加更多检测数据（DNS、TCP、SSL、TTFB等）
- ✅ 重新设计Web界面，增加6个分析面板
- ✅ 更新命令行工具，支持更多参数
- ✅ 修复CDN检测逻辑，提高准确性
- ✅ 增加SSL证书信息检测
- ✅ 增加性能评级功能

### v1.0.0
- ✅ 基础CDN检测功能
- ✅ Web界面测试
- ✅ 命令行工具
- ✅ API接口

---

如有问题或建议，请随时反馈。